name: Update Best CF IPs

on:
  schedule:
    # 每天每小时的第 0 分钟运行一次
    - cron: '0 * * * *'
  workflow_dispatch: # 允许手动触发运行

jobs:
  update-ips:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 必须赋予写入权限

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch API and Process IPs
        run: |
          # 定义所有使用到的文件的绝对路径
          WORKSPACE="$GITHUB_WORKSPACE"
          API_RESULT="$WORKSPACE/temp_api_result.json"
          HEIMD_FILE="$WORKSPACE/heimd"
          BLACKLIST="$WORKSPACE/temp_blacklist.txt"
          RAW_IPS="$WORKSPACE/temp_raw_ips.txt"
          FILTERED_IPS="$WORKSPACE/temp_filtered_ips.txt"
          BEST_IP_FILE="$WORKSPACE/bestcfip"

          # 1. 请求 API
          # -k: 跳过证书验证  -s: 静默模式  --retry 3: 失败重试3次
          curl -k -s --retry 3 --retry-delay 5 "https://vps789.com/openApi/cfIpApi" -o "$API_RESULT"
          
          if ! grep -q '"data"' "$API_RESULT"; then
            echo "API request failed or invalid response."
            cat "$API_RESULT"
            exit 1
          fi

          # 2. 处理黑名单文件 heimd
          # 如果 heimd 文件不存在，则自动创建一个，并写入提示信息
          if [ ! -f "$HEIMD_FILE" ]; then
            echo "# 请在此文件下方添加需要拉黑的IP，每行一个" > "$HEIMD_FILE"
            echo "Created heimd file at $HEIMD_FILE"
          fi

          # 提取黑名单中有效的 IPv4 地址，防止空行或注释干扰匹配 (|| true 防止为空时报错退出)
          grep -Eo '([0-9]{1,3}\.){3}[0-9]{1,3}' "$HEIMD_FILE" > "$BLACKLIST" || true

          # 3. 解析 JSON 并提取 API 返回的所有 IP，去重
          jq -r '.data[] | .[] | .ip' "$API_RESULT" | grep -Ev '^$|null' | sort -u > "$RAW_IPS"

          # 4. 过滤黑名单
          # -s 检查黑名单文件是否有内容，如果有，则使用 grep -v 剔除黑名单里的 IP
          if [ -s "$BLACKLIST" ]; then
            # -v: 反向匹配  -F: 按字符串匹配  -x: 匹配整行  -f: 从文件读取目标
            grep -v -F -x -f "$BLACKLIST" "$RAW_IPS" > "$FILTERED_IPS" || true
          else
            # 如果黑名单为空，直接复制
            cat "$RAW_IPS" > "$FILTERED_IPS"
          fi

          # 5. 格式化并覆盖写入 bestcfip 文件
          awk '{print $1"#优选"}' "$FILTERED_IPS" > "$BEST_IP_FILE"

          echo "Final Extracted IPs:"
          cat "$BEST_IP_FILE"

          # 6. 清理临时文件
          rm "$API_RESULT" "$BLACKLIST" "$RAW_IPS" "$FILTERED_IPS"

      - name: Commit and Push changes
        run: |
          WORKSPACE="$GITHUB_WORKSPACE"
          
          # 配置 GitHub Actions 机器人的 Git 信息
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          # 将生成/更新的 bestcfip 和 heimd 文件加入暂存区
          git add "$WORKSPACE/bestcfip" "$WORKSPACE/heimd"
          
          # 检查暂存区是否有实质性的变动
          if ! git diff --staged --quiet; then
            git commit -m "Auto-update bestcfip & heimd: $(date +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "Successfully pushed updated files."
          else
            echo "No changes detected. Skipping push."
          fi
