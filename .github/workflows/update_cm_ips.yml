name: Update CM Preferred IPs (vps789 cfIpApi)

on:
  schedule:
    # 每 60 分钟（每小时）执行一次
    - cron: "0 * * * *"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: update-cm-ips
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Fetch CM IPs and write CSV.txt
        shell: bash
        run: |
          set -euo pipefail

          cat > update_cm_ips.py << 'PY'
          import json
          import os
          import sys
          from datetime import datetime, timezone

          import urllib.request

          API_URL = "https://vps789.com/openApi/cfIpApi"
          OUTPUT_FILE = "CSV.txt"
          TAG = "#优选"

          def http_get_json(url: str) -> dict:
              req = urllib.request.Request(
                  url,
                  headers={
                      "User-Agent": "github-actions-cm-ip-updater/1.0",
                      "Accept": "application/json",
                  },
                  method="GET",
              )
              with urllib.request.urlopen(req, timeout=20) as resp:
                  data = resp.read().decode("utf-8", errors="replace")
              return json.loads(data)

          def main():
              try:
                  payload = http_get_json(API_URL)
              except Exception as e:
                  print(f"ERROR: failed to fetch API: {e}", file=sys.stderr)
                  sys.exit(1)

              if payload.get("code") != 0:
                  print(f"ERROR: API returned non-zero code: {payload}", file=sys.stderr)
                  sys.exit(1)

              data = payload.get("data") or {}
              cm_list = data.get("CM") or []

              if not isinstance(cm_list, list) or len(cm_list) == 0:
                  print("ERROR: CM list is empty or invalid.", file=sys.stderr)
                  sys.exit(1)

              # 规则：按 avgScore 从小到大（越小越好），再按 ydLatencyAvg 从小到大兜底
              def key_fn(x):
                  return (
                      x.get("avgScore", 10**9),
                      x.get("ydLatencyAvg", 10**9),
                      x.get("ydPkgLostRateAvg", 10**9),
                  )

              cm_sorted = sorted(cm_list, key=key_fn)

              # 去重（保持排序）
              seen = set()
              ips = []
              for item in cm_sorted:
                  ip = (item or {}).get("ip")
                  if not ip or not isinstance(ip, str):
                      continue
                  if ip in seen:
                      continue
                  seen.add(ip)
                  ips.append(ip)

              if not ips:
                  print("ERROR: no valid IPs extracted.", file=sys.stderr)
                  sys.exit(1)

              lines = [f"{ip}{TAG}" for ip in ips]
              content = "\n".join(lines) + "\n"

              # 覆盖写入 / 不存在则创建
              with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
                  f.write(content)

              # 打印一点日志
              now = datetime.now(timezone.utc).isoformat()
              print(f"[{now}] Wrote {len(ips)} IPs to {OUTPUT_FILE}")
              print("Top 5:")
              for ip in ips[:5]:
                  print(" -", ip)

          if __name__ == "__main__":
              main()
          PY

          python update_cm_ips.py

      - name: Commit & Push (if changed)
        shell: bash
        run: |
          set -euo pipefail
          if git status --porcelain | grep -qE '^\s*M\s+CSV\.txt|^\?\?\s+CSV\.txt'; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add CSV.txt
            git commit -m "chore: update CM preferred IPs"
            git push
          else
            echo "No changes to commit."
          fi
