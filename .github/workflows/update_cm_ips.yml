name: 朝阳的IP

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: chaoyang-ip
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Generate IPs and Log
        shell: bash
        run: |
          set -euo pipefail
          
          cat > chaoyang_ip.py << 'PY'
          import json, os, re, sys, time, ssl
          from datetime import datetime, timezone, timedelta
          from urllib.request import Request, urlopen
          from urllib.error import URLError, HTTPError

          API = "https://vps789.com/openApi/cfIpApi"
          OUT = "CSV.txt"
          EXC = "result.csv"
          LOG = "ip_log.txt"
          TAG = "#优选"
          
          BUILTIN = """
          172.64.159.213#优选
          104.17.144.235#优选
          104.17.182.11#优选
          104.16.158.249#优选
          172.64.152.111#优选
          104.17.22.240#优选
          104.18.95.26#优选
          104.16.248.48#优选
          104.16.251.148#优选
          172.64.145.194#优选
          108.162.198.198#优选
          """.strip()

          IPV4 = re.compile(r"^(?:\d{1,3}\.){3}\d{1,3}$")

          def check_ip(ip):
              if not IPV4.match(ip): return False
              try: return all(0<=int(p)<=255 for p in ip.split("."))
              except: return False

          def get_ips(text):
              res = []
              seen = set()
              for line in text.splitlines():
                  s = line.strip()
                  if not s: continue
                  ip = s.split("#")[0].strip()
                  if check_ip(ip) and ip not in seen:
                      seen.add(ip)
                      res.append(ip)
              return res

          def get_exc():
              if not os.path.exists(EXC): return set()
              try:
                  with open(EXC, "r", encoding="utf-8", errors="ignore") as f:
                      return set(get_ips(f.read()))
              except: return set()

          def fetch_api():
              ctx = ssl.create_default_context()
              ctx.check_hostname = False
              ctx.verify_mode = ssl.CERT_NONE
              
              for i in range(4):
                  try:
                      req = Request(API, headers={"User-Agent":"gh-action"}, method="GET")
                      with urlopen(req, timeout=20, context=ctx) as r:
                          d = json.loads(r.read().decode("utf-8"))
                      if d.get("code")!=0: continue
                      
                      cm = d.get("data", {}).get("CM", [])
                      cm.sort(key=lambda x: (x.get("avgScore", 9e9), x.get("ydLatencyAvg", 9e9)))
                      
                      ips = []
                      seen = set()
                      for item in cm:
                          ip = str(item.get("ip","")).strip()
                          if check_ip(ip) and ip not in seen:
                              seen.add(ip)
                              ips.append(ip)
                      return ips
                  except:
                      time.sleep(1.5 * (2**i))
              return []

          def main():
              b_ips = get_ips(BUILTIN)
              exc_set = get_exc()
              api_ips = fetch_api()
              
              seen = set(b_ips)
              final = list(b_ips)
              
              dups = []
              
              for ip in api_ips:
                  if ip in seen:
                      dups.append(ip)
                  else:
                      seen.add(ip)
                      final.append(ip)
              
              final = [ip for ip in final if ip not in exc_set]
              
              with open(OUT, "w", encoding="utf-8") as f:
                  f.write("\n".join(f"{x}{TAG}" for x in final) + "\n" if final else "")
              
              cn_time = datetime.now(timezone(timedelta(hours=8))).strftime("%Y-%m-%d %H:%M:%S")
              
              log_msg = [
                  f"[{cn_time}] Run Summary",
                  f"API IPs Found ({len(api_ips)}): {', '.join(api_ips) if api_ips else 'None'}",
                  f"Duplicates Removed ({len(dups)}): {', '.join(dups) if dups else 'None'}",
                  "-"*60 + "\n"
              ]
              
              with open(LOG, "a", encoding="utf-8") as f:
                  f.write("\n".join(log_msg))

          if __name__ == "__main__":
              main()
          PY
          
          python chaoyang_ip.py

      - name: Commit & Push
        shell: bash
        run: |
          set -euo pipefail
          
          # 同时检查 CSV.txt 和 ip_log.txt 的变化
          if git status --porcelain | grep -qE 'CSV\.txt|ip_log\.txt'; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add CSV.txt ip_log.txt
            git commit -m "update: IPs & log [skip ci]"
            git push
          else
            echo "No changes."
          fi
